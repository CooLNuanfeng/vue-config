(function(a,b){a.ui.refresh.register(function(){return{pluginName:"iOS5",_init:function(){var d=this,e=d._data,c=d.root();d._initOrg();c.css({overflow:"scroll","-webkit-overflow-scrolling":"touch"});e.topOffset=e["$upElem"]?e["$upElem"].height():0;e.iScroll=d._getiScroll();c.get(0).scrollTop=e.topOffset;c.on("touchstart touchmove touchend",a.proxy(d._eventHandler,d))},_changeStyle:function(c,g){var d=this,f=d._data,e=f.refreshInfo[c];d._changeStyleOrg(c,g);switch(g){case"loaded":e["$icon"].addClass("ui-refresh-icon");f._actDir="";break;case"beforeload":e["$label"].html("\u677e\u5f00\u7acb\u5373\u52a0\u8f7d");e["$icon"].addClass("ui-refresh-flip");break;case"loading":e["$icon"].removeClass().addClass("ui-loading");break}return d},_scrollStart:function(h){var f=this,g=f._data,d=g.topOffset,c=g.$upElem,j=f.root().get(0),i=function(){clearTimeout(f.data("topOffsetTimer"));if(c&&c.length&&j.scrollTop<=d&&!g._upRefreshed){j.scrollTop=d}};f.trigger("scrollstart",h);f._enableScroll()._bindScrollStop(j,i);g.maxScrollY=j.offsetHeight-j.scrollHeight;g._scrollFn=i;return f},_scrollMove:function(){var e=this,f=e._data,d=f.$upElem&&f.$upElem.length,h=f.$downElem&&f.$downElem.length,g=e.root().get(0),c=f.threshold||5;e._scrollMove=function(p){var l=f.maxScrollY,o=g.scrollTop,i=f.lastMoveY||o,j=f._upRefreshed,k=f._downRefreshed,n=e._status("up"),m=e._status("down");if(d&&!n||h&&!m){return}f.iScroll.deltaY=o-i;if(m&&h&&!k&&-o<(l-c)){e._setMoveState("down","beforeload","pull")}else{if(m&&h&&k&&-o>(l-c)&&-o!==l){e._setMoveState("down","loaded","restore")}else{if(n&&d&&!j&&-o>c){e._setMoveState("up","beforeload","pull")}else{if(n&&d&&j&&-o<c&&o){e._setMoveState("up","loaded","restore")}}}}f.lastMoveY=o;f._moved=true;return e.trigger("scrollmove",p,o,o-i)};e._scrollMove.apply(e,arguments)},_scrollEnd:function(i){var d=this,g=d._data,j=d.root().get(0),c=g.topOffset,f=g._actDir,h=g._restoreDir;if((h=="up"||j.scrollTop<=c)&&!f&&g._moved){d.data("topOffsetTimer",a.later(function(){a(j).off("scroll",g._scrollFn);j.scrollTop=c},800))}if(f&&d._status(f)){d._setStyle(f,"loading");d._loadingAction(f,"pull")}g._moved=false;return d.trigger("scrollend",i)},_enableScroll:function(){var c=this,e=c.root().get(0),d=e.scrollTop;d<=0&&(e.scrollTop=1);if(d+e.offsetHeight>=e.scrollHeight){e.scrollTop=e.scrollHeight-e.offsetHeight-1}return c},_bindScrollStop:function(f,d){var e=this,c=a(f);c.off("scroll",e._data._scrollFn).on("scroll",a.debounce(100,function(){c.off("scroll",arguments.callee).one("scroll",d)},false));return e},_getiScroll:function(){var c=this,d=c.root(),e=d[0];return{el:e,deltaY:0,scrollTo:function(h,g,f){if(f){h=e.scrollTop+h}d.css({"-webkit-transition-property":"scrollTop","-webkit-transition-duration":h+"ms"});e.scrollTop=h},disable:function(f){f&&c.destroy();d.css("overflow","hidden")},enable:function(){d.css("overflow","scroll")}}},_setMoveState:function(c,g,e){var d=this,f=d._data;d._setStyle(c,g);f["_"+c+"Refreshed"]=e=="pull";f._actDir=e=="pull"?c:"";f._restoreDir=c=="up"&&e=="restore"?c:"";return d},_eventHandler:function(d){var c=this;switch(d.type){case"touchstart":c._scrollStart(d);break;case"touchmove":c._scrollMove(d);break;case"touchend":c._scrollEnd(d);break}},afterDataLoading:function(c){var d=this,e=d._data,c=c||e._actDir;e["_"+c+"Refreshed"]=false;c=="up"&&(d.root().get(0).scrollTop=e.topOffset);return d.afterDataLoadingOrg(c)}}})})(Zepto);